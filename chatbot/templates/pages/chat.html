{% extends "base.html" %}

{% load static %}

{% block title %}
  Chat with Bot
{% endblock title %}
{% block content %}
  {% if user.is_authenticated %}
    <h1>Chat with Bot</h1>
    <div id="chat-box">
      <form id="chat-form" method="post">
        {% csrf_token %}
        <div id="messages" class="mb-3">
          {% for message in messages %}
            <div>
              <strong>User:</strong> {{ message.user_message|linebreaks }}
            </div>
            <div>
              <strong>Bot:</strong> {{ message.bot_response|linebreaks }}
            </div>
          {% endfor %}
        </div>
        <input type="text"
               id="user-input"
               name="message"
               class="form-control mb-2"
               placeholder="Type your message..."
               required />
        <button type="button" id="send-button" class="btn btn-primary">Send</button>
      </form>
    </div>
  {% else %}
    <p>
      You need to be signed in to chat with the bot. <a href="{% url 'account_login' %}">Log in here</a>.
    </p>
  {% endif %}
{% endblock content %}
{% block inline_javascript %}
  {% if user.is_authenticated %}
    <script>
      $(document).ready(function() {
        $('#send-button').click(function() {
          var message = $('#user-input').val();

          if (message.trim() === '') {
            return;
          }

          // Append user's message
          $('#messages').append('<div><strong>User:</strong> ' + message + '</div>');

          // Send the message via POST request
          $.post("{% url 'app:chat' %}", {
            message: message,
            csrfmiddlewaretoken: '{{ csrf_token }}'
          }, function(data) {
            // Replace newlines in bot's response with <br /> tags
            var botResponse = data.response.replace(/\n/g, '<br />');

            // Append bot's response with line breaks
            $('#messages').append('<div><strong>Bot:</strong> ' + botResponse + '</div>');
            $('#user-input').val(''); // Clear input field
          }).fail(function() {
            $('#messages').append('<div><strong>Bot:</strong> Error processing your request.</div>');
          });
        });

        // Handle form submission
        $('#chat-form').on('submit', function(event) {
          event.preventDefault();
          $('#send-button').click();
        });
      });
    </script>
  {% endif %}
{% endblock inline_javascript %}
